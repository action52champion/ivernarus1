<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ivernarus1</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #fafbfc;
      --bg-card: #ffffff;
      --bg-hover: #f5f7fa;
      --border: #e1e8ed;
      --border-focus: #6b8cae;
      --text-primary: #1a2332;
      --text-secondary: #5a6d7f;
      --text-muted: #8b9ba8;
      --accent: #4a7ba7;
      --accent-hover: #3a6a95;
      --danger: #d14343;
      --danger-hover: #b93838;
      --success: #3ea368;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --radius: 8px;
      --font-display: 'Crimson Pro', serif;
      --font-body: 'DM Sans', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text-primary);
      font-family: var(--font-body);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 32px 24px;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      max-width: 720px;
      margin: 0 auto;
    }

    h1 {
      font-family: var(--font-display);
      font-size: 36px;
      font-weight: 600;
      letter-spacing: -0.5px;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      letter-spacing: 0.3px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .btn-outline {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
      font-size: 13px;
      padding: 8px 16px;
    }

    .btn-outline:hover {
      background: var(--accent);
      color: white;
    }

    /* â”€â”€ Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container {
      flex: 1;
      max-width: 720px;
      width: 100%;
      margin: 0 auto;
      padding: 40px 24px;
    }

    /* â”€â”€ Main Page (Contact List) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #mainPage {
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .contact-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 32px;
    }

    .contact-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .contact-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--border-focus);
    }

    .contact-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6b8cae 0%, #4a7ba7 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
      text-transform: uppercase;
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-name {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .contact-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .contact-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .btn {
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 500;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .btn-secondary {
      background: var(--bg-hover);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      box-shadow: var(--shadow-md);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    /* â”€â”€ Add Contact Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-contact-bar {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      display: flex;
      gap: 12px;
      box-shadow: var(--shadow-sm);
    }

    .add-contact-bar input {
      flex: 1;
      font-family: var(--font-body);
      font-size: 15px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .add-contact-bar input:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(107, 140, 174, 0.1);
    }

    .add-contact-bar input::placeholder {
      color: var(--text-muted);
    }

    /* â”€â”€ Edit Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #editPage {
      animation: fadeIn 0.4s ease;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
      text-decoration: none;
      margin-bottom: 24px;
      transition: color 0.2s ease;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      font-family: var(--font-body);
    }

    .back-button:hover {
      color: var(--accent);
    }

    .edit-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: var(--shadow-md);
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group:last-of-type {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      font-family: var(--font-body);
      font-size: 15px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(107, 140, 174, 0.1);
    }

    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: 6px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-hover);
    }

    .file-upload-area:hover {
      border-color: var(--border-focus);
      background: var(--bg);
    }

    .file-upload-area.has-file {
      border-color: var(--success);
      background: rgba(62, 163, 104, 0.05);
    }

    .file-upload-icon {
      font-size: 32px;
      margin-bottom: 12px;
      color: var(--text-muted);
    }

    .file-upload-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .file-upload-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    input[type="file"] {
      display: none;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 24px;
    }

    .info-box {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
    }

    .info-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .checkbox-label {
      font-size: 15px;
      font-weight: 400;
      color: var(--text-primary);
      text-transform: none;
      letter-spacing: normal;
      margin-bottom: 0;
      cursor: pointer;
      user-select: none;
    }


    .info-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: var(--font-display);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .form-actions .btn {
      flex: 1;
      padding: 14px 24px;
      font-size: 15px;
    }

    /* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state-title {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hidden {
      display: none !important;
    }

    /* â”€â”€ Chat Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chatPage {
      animation: fadeIn 0.4s ease;
    }

    .chat-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .chat-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6b8cae 0%, #4a7ba7 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 600;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .chat-header-info {
      flex: 1;
    }

    .chat-contact-name {
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .chat-contact-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .chat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 32px;
      box-shadow: var(--shadow-md);
    }

    .message-group {
      margin-bottom: 24px;
    }

    .message-group:last-of-type {
      margin-bottom: 0;
    }

    .message-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    textarea {
      width: 100%;
      font-family: var(--font-body);
      font-size: 15px;
      line-height: 1.6;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      resize: vertical;
      min-height: 120px;
    }

    textarea:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(107, 140, 174, 0.1);
    }

    textarea::placeholder {
      color: var(--text-muted);
    }

    .chat-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 24px;
    }

    .chat-actions .btn {
      padding: 14px 24px;
      font-size: 15px;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      .header { padding: 24px 16px; }
      h1 { font-size: 28px; }
      .container { padding: 24px 16px; }
      .contact-item { padding: 16px; flex-wrap: wrap; }
      .contact-avatar { width: 40px; height: 40px; font-size: 18px; }
      .contact-actions { width: 100%; justify-content: flex-end; }
      .add-contact-bar { flex-direction: column; }
      .edit-card { padding: 24px; }
      .info-grid { grid-template-columns: 1fr; }
      .form-actions { flex-direction: column; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-content">
    <h1>Ivernarus1</h1>
    <div class="header-actions">
      <button class="btn btn-outline" onclick="app.exportData()">â†“ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ±Ğ°Ğ·Ñ‹</button>
      <button class="btn btn-outline" onclick="document.getElementById('importFileInput').click()">â†‘ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ±Ğ°Ğ·Ñ‹</button>
      <input type="file" id="importFileInput" accept=".json,application/json" onchange="app.importData(event)" style="display: none;" />
    </div>
  </div>
</div>

<div class="container">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- MAIN PAGE (Contact List) -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="mainPage">
    <div class="contact-list" id="contactList">
      <!-- Contacts will be rendered here -->
    </div>

    <div class="add-contact-bar">
      <input type="text" id="newContactName" placeholder="Ğ˜Ğ¼Ñ..." />
      <button class="btn btn-primary" onclick="app.createContact()">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- EDIT PAGE -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="editPage" class="hidden">
    <button class="back-button" onclick="app.showMainPage()">
      â† ĞĞ°Ğ·Ğ°Ğ´ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ
    </button>

    <div class="edit-card">
      <div class="form-group">
        <label for="editName">Ğ˜Ğ¼Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°</label>
        <input type="text" id="editName" placeholder="Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜Ğ²Ğ°Ğ½" />
      </div>

      <div class="form-group">
        <label>ĞšĞ»ÑÑ‡ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ</label>
        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('keyFileInput').click()">
          <div class="file-upload-icon">ğŸ“„</div>
          <div class="file-upload-text" id="fileUploadText">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»</div>
          <div class="file-upload-hint"></div>
        </div>
        <input type="file" id="keyFileInput" accept=".txt,text/plain" onchange="app.handleKeyUpload(event)" />

      <div class="form-actions">
        <button class="btn btn-secondary" onclick="app.generateKey()">ğŸ² Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡</button>
        <button class="btn btn-secondary" onclick="app.shareKey()">ğŸ’¾ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° ĞºĞ»ÑÑ‡Ğ°</button>
      </div>

      </div>

      <div class="form-group">
        <div class="checkbox-wrapper">
          <input type="checkbox" id="editKeyCleanup" />
          <label for="editKeyCleanup" class="checkbox-label">
            ĞŸĞ¾Ğ´Ñ€ĞµĞ·Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡(ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 1 Ñ€Ğ°Ğ·)
          </label>
        </div>
        <div class="checkbox-wrapper">
          <input type="checkbox" id="editDeniability" />
          <label for="editDeniability" class="checkbox-label">
            ĞŸÑ€ÑÑ‚Ğ°Ñ‚ÑŒ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ ÑĞ»Ğ¾Ğ², Ñ†Ğ¸Ñ„Ñ€Ñ‹, ÑĞ¿ĞµÑ†Ğ·Ğ½Ğ°ĞºĞ¸ Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸
          </label>
        </div>
      </div>


      <div class="info-grid">
        <div class="info-box">
          <div class="info-label">Ğ”Ğ»Ğ¸Ğ½Ğ° ĞºĞ»ÑÑ‡Ğ°</div>
          <div class="info-value" id="keyLengthDisplay">â€”</div>
        </div>
        <div class="info-box">
          <div class="info-label">ID ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°</div>
          <div class="info-value" id="contactIdDisplay">â€”</div>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-secondary" onclick="app.showMainPage()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
        <button class="btn btn-danger" id="deleteBtn" onclick="app.deleteContact()">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
        <button class="btn btn-primary" onclick="app.saveContact()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- CHAT PAGE -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="chatPage" class="hidden">
    <button class="back-button" onclick="app.showMainPage()">
      â† ĞĞ°Ğ·Ğ°Ğ´ Ğº ÑĞ¿Ğ¸ÑĞºÑƒ
    </button>

    <div class="chat-header">
      <div class="chat-avatar" id="chatAvatar"></div>
      <div class="chat-header-info">
        <div class="chat-contact-name" id="chatContactName"></div>
        <div class="chat-contact-meta" id="chatContactMeta"></div>
      </div>
    </div>

    <div class="chat-card">
      <div class="message-group">
        <label class="message-label" for="inputMessage">ĞĞ±Ñ‹Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ</label>
        <textarea id="inputMessage" placeholder="Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚..."></textarea>
      </div>

      <div class="chat-actions">
        <button class="btn btn-primary" onclick="app.encodeMessage()">ğŸ”’ Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
        <button class="btn btn-secondary" onclick="document.getElementById('inputMessage').value='';">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ</button>
      </div>

      <br/><br/>

      <div class="message-group">
        <label class="message-label" for="outputMessage">Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ</label>
        <textarea id="outputMessage" placeholder="Ğ—Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚..." ></textarea>
      </div>
      <div class="chat-actions">
        <button class="btn btn-primary" onclick="app.decodeMessage()">ğŸ”“ Ğ Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
        <button class="btn btn-secondary" onclick="document.getElementById('outputMessage').value='';">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ</button>
      </div>
    </div>
  </div>

</div>

<script type="text/javascript">
class IVernarus1 {

    alphanumAlphabets = [
        'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
        'abcdefghijklmnopqrstuvwxyz',
        '0123456789',
        'ĞĞ‘Ğ’Ğ“Ğ”Ğ•ĞĞ–Ğ—Ğ˜Ğ™ĞšĞ›ĞœĞĞĞŸĞ Ğ¡Ğ¢Ğ£Ğ¤Ğ¥Ğ¦Ğ§Ğ¨Ğ©ĞªĞ«Ğ¬Ğ­Ğ®Ğ¯',
        'Ğ°Ğ±Ğ²Ğ³Ğ´ĞµÑ‘Ğ¶Ğ·Ğ¸Ğ¹ĞºĞ»Ğ¼Ğ½Ğ¾Ğ¿Ñ€ÑÑ‚ÑƒÑ„Ñ…Ñ†Ñ‡ÑˆÑ‰ÑŠÑ‹ÑŒÑÑÑ'
    ];

    deniableAlphabet = ' -,.<>!?/\\+=-_)(*&^%$#@`|â„–;:';

    keyAlphabet = 'Ğ°Ğ±Ğ²Ğ³Ğ´ĞµÑ‘Ğ¶Ğ·Ğ¸Ğ¹ĞºĞ»Ğ¼Ğ½Ğ¾Ğ¿Ñ€ÑÑ‚ÑƒÑ„Ñ…Ñ†Ñ‡ÑˆÑ‰ÑŠÑ‹ÑŒÑÑÑ';
    keyPosLength = 4;

    extraDataLength = 6;

    encoders = [];

    lastKeyPos = 0;

    lastError = null;

    constructor(keyData, keyPos = 0, options = {}) {
        this.keyData = keyData;
        this.keyPos = keyPos;

        if (options.deniability !== null) {
            this.deniability = options.deniability;
        }

        this.alphabets = this.alphanumAlphabets;

        if (this.deniability) {
            this.alphabets.push(this.deniableAlphabet);
            this.alphabets = [ this.alphabets.join("") ];
        }

        for (let i = 0; i < this.alphabets.length; i++) {
            this.encoders[i] = this.alphabets[i] + this.alphabets[i];
        }

        this.encodableChars = this.alphabets.join("");
    }

    textToUtf8Array(text) {
        let out = [];
        const iterator = text[Symbol.iterator]();
        while (true) {
            const charIter = iterator.next();
            if (charIter.done)
                break;
            out.push(charIter.value);
        }

        return out;
    }

    encryptChunk(key, msg) {
        const iterator = msg[Symbol.iterator]();

        let outMsg = '';

        let keyPos = 0;
        while (true) {
            const charIter = iterator.next();
            if (charIter.done)
                break;

            const char = charIter.value;
            let replaced = false;
            for (let i = 0; i < this.alphabets.length; i++) {
                const charPos = this.alphabets[i].indexOf(char);
                if (charPos != -1) {
                    const encoderPos = charPos + key[keyPos].charCodeAt(0) % this.alphabets[i].length;
                    outMsg += this.encoders[i][ encoderPos ];
                    keyPos++;
                    replaced = true;
                }
            }

            if (! replaced) {
                outMsg += char;
            }
        }

        return outMsg;
    }

    decryptChunk(key, msg) {
        const iterator = msg[Symbol.iterator]();

        let outMsg = '';

        let keyPos = 0;
        while (true) {
            const charIter = iterator.next();
            if (charIter.done)
                break;

            const char = charIter.value;
            let replaced = false;
            for (let i = 0; i < this.alphabets.length; i++) {
                const charPos = this.alphabets[i].indexOf(char);
                if (charPos != -1) {
                    const encoderPos = this.alphabets[i].length + charPos - ( key[keyPos].charCodeAt(0) % this.alphabets[i].length );
                    outMsg += this.encoders[i][ encoderPos ];
                    keyPos++;
                    replaced = true;
                }
            }

            if (! replaced) {
                outMsg += char;
            }
        }

        return outMsg;
    }

    encodeKeyPos(pos) {
        let encodedKeyPos = '';
        let slidePos = pos;
        while (true) {
            const nextDigit = this.keyAlphabet[slidePos % this.keyAlphabet.length];
            slidePos = Math.floor(slidePos / this.keyAlphabet.length);

            encodedKeyPos = nextDigit + encodedKeyPos;

            if (slidePos === 0)
                break;
        }

        while ( encodedKeyPos.length < this.keyPosLength)
            encodedKeyPos = this.keyAlphabet[0] + encodedKeyPos;

        return encodedKeyPos;
    }

    // ÑÑƒĞ¼Ğ¼Ğ° ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‚ĞµÑ… ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹
    calculateChecksum(msg) {
        const msgData = this.textToUtf8Array(msg);

        let checksum = 0;
        for (let i = 0; i < msgData.length; i++) {
            const charPos = this.encodableChars.indexOf(msgData[i]);
            if (charPos != -1) {
                checksum += charPos;
            }
        }

        checksum = checksum % this.keyAlphabet.length;
        checksum = this.keyAlphabet[checksum];

        return checksum;
    }

    // Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ´ĞµĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² ÑƒĞ¶Ğµ Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    appendDecoderData(msg, extraValues) {
        
        const msgChars = this.textToUtf8Array(msg);

        let appendPos = 0;

        const neededChars = this.alphabets.join("");
        for (let i = msgChars.length; i > 0; i--) {
            if (neededChars.indexOf(msgChars[i]) !== -1) {
                appendPos = i;
                break;
            }           
        }

        return msg.substring(0, appendPos+1) + extraValues.join("") + msg.substring(appendPos+1);
    }

    // Ñ€Ğ°Ğ·Ğ±Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğ° ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½ÑƒÑ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ¸ ÑĞ°Ğ¼ Ñ‚ĞµĞºÑÑ‚
    parseMessage(msg) {
        const neededChars = this.alphabets.join("");
        
        let keyDataEndPos = 0;
        let msgChars = this.textToUtf8Array(msg);

        for (let i = msgChars.length - 1; i > 0; i--) {
            if (neededChars.indexOf(msgChars[i]) !== -1) {
                keyDataEndPos = i;
                break;
            }            
        }

        const keyPosData = [];
        for (let i = 0; i < this.keyPosLength; i++) {
            keyPosData.push(msgChars[keyDataEndPos + 1 + i - this.keyPosLength]);
        }

        const checksum = msgChars[keyDataEndPos - this.keyPosLength];
        let deniability = msgChars[keyDataEndPos - this.keyPosLength - 1];
        deniability = this.keyAlphabet[deniability];

        const indexBeforeEncoderData = keyDataEndPos - this.keyPosLength - 1;
        const message = msgChars.slice(0, indexBeforeEncoderData ).join("") + msgChars.slice(keyDataEndPos+1).join("");

        return {
            deniability: deniability,
            message : message,
            checksum: checksum,
            keypos: keyPosData
        };
            
    }

    decodeKeyPos(keyPosData) {
        const iterator = keyPosData[Symbol.iterator]();

        let decimal = 0;
        const base = this.keyAlphabet.length;
        for (let i = 0; i < this.keyPosLength; i++) {
            const digit = this.keyAlphabet.indexOf(iterator.next().value);
            const power = this.keyPosLength - 1 - i;
            decimal += digit * Math.pow(base, power);
        }

        return decimal;
    }

    encryptMessage(srcMsg) {
        const keyPiece = this.keyData.substring(this.keyPos, this.keyPos + srcMsg.length);

        let outMsg = this.encryptChunk(keyPiece, srcMsg);
        
        const keyPosEncoded = this.encodeKeyPos(this.keyPos);
        const checksum = this.calculateChecksum(srcMsg);

        const deniability = this.deniability ? this.keyAlphabet[1] : this.keyAlphabet[1];
        outMsg = this.appendDecoderData(outMsg, [deniability, checksum, keyPosEncoded]);
        this.lastKeyPos = this.keyPos + srcMsg.length;
        
        return outMsg;
    }

    decryptMessage(srcMsg) {
        const decodedData = this.parseMessage(srcMsg);
        const keyPos = this.decodeKeyPos(decodedData.keypos);
        const keyPiece = this.keyData.substring(keyPos, keyPos + decodedData.message.length);

        let decodedMessage = this.decryptChunk(keyPiece, decodedData.message);
        if (this.calculateChecksum(decodedMessage) !== decodedData.checksum) {
            this.lastError = 'ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ½Ğµ ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ÑÑ. Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ğ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¾. Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµÑ‚ÑÑ - Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€ Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ½Ğ°Ğ¼ĞµÑ€ĞµĞ½Ğ½Ğ¾.';
        }
        this.lastKeyPos = keyPos + decodedMessage.length;

        return decodedMessage;
    }

};
</script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Address Book Application
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const app = {
  currentContactId: null,
  uploadedKey: null,

  // â”€â”€ Initialize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  init() {
    this.loadData();
    this.render();
    
    // Enter key to add contact
    document.getElementById('newContactName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.createContact();
    });
  },

  // â”€â”€ Data Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadData() {
    const stored = localStorage.getItem('addressBook');
    if (stored) {
      this.data = JSON.parse(stored);
    } else {
      this.data = {
        last_id: 1,
        contacts: {}
      };
      this.saveData();
    }
  },

  saveData() {
    localStorage.setItem('addressBook', JSON.stringify(this.data));
  },

  // â”€â”€ Main Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  render() {
    const contactList = document.getElementById('contactList');
    const contacts = Object.entries(this.data.contacts);

    if (contacts.length === 0) {
      contactList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“‡</div>
          <div class="empty-state-title">No contacts yet</div>
          <div class="empty-state-text">Add your first contact below</div>
        </div>
      `;
      return;
    }

    contactList.innerHTML = contacts
      .sort((a, b) => a[1].name.localeCompare(b[1].name))
      .map(([id, contact]) => {
        const initial = contact.name.charAt(0).toUpperCase();
        const keyInfo = contact.key_in ? `ĞšĞ»ÑÑ‡: ${contact.key_in.length} Ğ±ÑƒĞºĞ²` : 'ĞĞµÑ‚ ĞºĞ»ÑÑ‡Ğ°';
        
        return `
          <div class="contact-item">
            <div class="contact-avatar">${initial}</div>
            <div class="contact-info">
              <div class="contact-name">${this.escapeHtml(contact.name)}</div>
              <div class="contact-meta">${keyInfo} Â· ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾: ${contact.key_in ? (contact.key_in_position/contact.key_in.length * 100).toFixed(2) : 0}% / ${contact.key_out ? (contact.key_out_position/contact.key_out.length * 100).toFixed(2) : 0}%</div>
            </div>
            <div class="contact-actions">
              <button class="btn btn-secondary" onclick="app.editContact('${id}')">ĞŸÑ€Ğ°Ğ²ĞºĞ°</button>
              <button class="btn btn-primary" onclick="app.openChat('${id}')">Ğ§Ğ°Ñ‚</button>
            </div>
          </div>
        `;
      })
      .join('');
  },

  createContact() {
    const nameInput = document.getElementById('newContactName');
    const name = nameInput.value.trim();
    
    if (!name) {
      alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°');
      return;
    }

    const newId = this.data.last_id;
    this.data.contacts[newId] = {
      name: name,
      key_in: '',
      key_in_position: 0,
      key_out: '',
      key_out_position: 0,
      key_cleanup: false,
      use_deniability: false
    };

    this.data.last_id++;
    this.saveData();

    nameInput.value = '';
    this.editContact(newId);
  },

  editContact(contactId) {
    this.currentContactId = contactId;
    this.uploadedKey = null;
    
    const contact = this.data.contacts[contactId];
    
    document.getElementById('editName').value = contact.name;
    document.getElementById('contactIdDisplay').textContent = contactId;
    document.getElementById('editKeyCleanup').checked = contact.key_cleanup || false;
    document.getElementById('editDeniability').checked = contact.use_deniability || false;
    
    // if (contact.key_in) {
    //   document.getElementById('keyLengthDisplay').textContent = contact.key_in.length;
    //   document.getElementById('fileUploadText').textContent = 'ĞšĞ»ÑÑ‡ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½ (Ğ½Ğµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒÑ‚Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ!)';
    //   document.getElementById('fileUploadArea').classList.add('has-file');
    // } else {
      document.getElementById('keyLengthDisplay').textContent = 'â€”';
      document.getElementById('fileUploadText').textContent = 'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° ĞºĞ»ÑÑ‡Ğ°';
      document.getElementById('fileUploadArea').classList.remove('has-file');
    // }

    this.showEditPage();
  },

  saveContact() {
    const name = document.getElementById('editName').value.trim();

    if (!name) {
      alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°');
      return;
    }

    const contact = this.data.contacts[this.currentContactId];
    contact.name = name;

    const keyCleanup = document.getElementById('editKeyCleanup').checked;
    contact.key_cleanup = keyCleanup;

    const use_deniability = document.getElementById('editDeniability').checked;
    contact.use_deniability = use_deniability;

    
    if (this.uploadedKey !== null) {

        // Ğ¿ĞµÑ€Ğ²Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ ĞºĞ»ÑÑ‡Ğ° Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ…
        contact.key_in = this.uploadedKey.substring(0, Math.floor(this.uploadedKey.length / 2) );
        contact.key_in_position = 0;

        // Ğ²Ñ‚Ğ¾Ñ€Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ ĞºĞ»ÑÑ‡Ğ° Ğ´Ğ»Ñ Ğ¸ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ…
        contact.key_out = this.uploadedKey.substring(Math.floor(this.uploadedKey.length / 2) );
        contact.key_out_position = 0;
    }

    this.saveData();
    this.showMainPage();
    this.render();
  },

  deleteContact() {
    if (!confirm('Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚?')) {
      return;
    }

    delete this.data.contacts[this.currentContactId];
    this.saveData();
    this.showMainPage();
    this.render();
  },

  generateKey() {
    // First confirmation
    if (!confirm('âš ï¸ Ğ­Ñ‚Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»ÑÑ‡, ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½. Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹?')) {
      return;
    }

    // Second confirmation
    if (!confirm('âš ï¸ Ğ‘ĞµĞ· ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ° Ğ²Ñ‹ Ğ½Ğµ ÑĞ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¾Ğ±Ñ‰Ğ°Ñ‚ÑŒÑÑ Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ¼, Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ´Ğ¸Ñ‚Ğµ ĞµĞ¼Ñƒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ»ÑÑ‡! Ğ’Ñ‹ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹?')) {
      return;
    }

    let keySize = 768 * 1024;

    const printableStart = 32;  // Space
    const printableEnd = 126;   // ~
    const printableRange = printableEnd - printableStart + 1;


    let randomArray = [];
    while (randomArray.length < keySize) {
        let tmpArray = new Uint8Array(1024);
        window.crypto.getRandomValues(tmpArray);
        randomArray.push(...tmpArray);
    }

    let key = '';
    for (let i = 0; i < keySize; i++) {
      const randomChar = String.fromCharCode(
        printableStart + (randomArray[i] % printableRange)
      );
      key += randomChar;
    }

    // Update UI and internal state
    this.uploadedKey = key;
    document.getElementById('keyLengthDisplay').textContent = key.length.toLocaleString();
    document.getElementById('fileUploadText').textContent = `Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ ĞºĞ»ÑÑ‡ Ğ½Ğ° ${keySize} Ğ±ÑƒĞºĞ²`;
    document.getElementById('fileUploadArea').classList.add('has-file');

    alert('âœ… ĞšĞ»ÑÑ‡ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½! ĞĞµ Ğ·Ğ°Ğ±ÑƒĞ´ÑŒÑ‚Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚!');
  },

  shareKey() {
    const contact = this.data.contacts[this.currentContactId];
    
    // Check if there's a key to export (either saved or newly uploaded/generated)
    let keyToExport = this.uploadedKey !== null ? this.uploadedKey : (contact.key_in + contact.key_out);
    
    if (!keyToExport) {
      alert('ĞĞµÑ‡ĞµĞ³Ğ¾ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ! Ğ¡Ğ¿ĞµÑ€Ğ²Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¸Ğ»Ğ¸ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ĞºĞ»ÑÑ‡.');
      return;
    }

    // Ğ’ ÑĞ»ÑƒÑ‡Ğ°Ğµ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğ¸ Ğ¸ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ ĞºĞ»ÑÑ‡ Ğ¼ĞµÑÑ‚Ğ°Ğ¼Ğ¸
    const key_in = keyToExport.substring(Math.floor(keyToExport.length / 2));
    const key_out = keyToExport.substring(0, Math.floor(keyToExport.length / 2) );

    keyToExport = key_in + key_out;

    // Create filename: contact name + ".ivernus1.txt"
    const safeName = contact.name.replace(/[^Ğ-Ğ¯Ğ°-Ña-zA-Z0-9-_]/g, '_');
    const filename = `${safeName}.ivernus1.txt`;

    // Create and download file
    const blob = new Blob([keyToExport], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  },

  handleKeyUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      this.uploadedKey = e.target.result;
      document.getElementById('keyLengthDisplay').textContent = this.uploadedKey.length;
      document.getElementById('fileUploadText').textContent = file.name;
      document.getElementById('fileUploadArea').classList.add('has-file');
      document.querySelector('.file-upload-hint').textContent = 'ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ĞºĞ»ÑÑ‡ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ğ»ÑÑ!';
    };
    reader.readAsText(file);
  },

  updateContactKeyLeftStat(contact) {
      const out = `ĞšĞ»ÑÑ‡: ğŸ”’${contact.key_in.length ? (contact.key_in_position/contact.key_in.length * 100).toFixed(2) : 0}% [Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ±ÑƒĞºĞ²: ${contact.key_in.length - contact.key_in_position}]/ ğŸ”“: ${contact.key_out.length ? (contact.key_out_position/contact.key_out.length * 100).toFixed(2) : 0}% [Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ±ÑƒĞºĞ²: ${contact.key_out.length - contact.key_out_position}]`;

      document.getElementById('chatContactMeta').textContent = out;
  },


  openChat(contactId) {
    this.currentContactId = contactId;
    const contact = this.data.contacts[contactId];
    
    if (!contact.key_in) {
      alert('Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ»ÑÑ‡ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°');
      this.editContact(contactId);
      return;
    }

    this.updateContactKeyLeftStat(contact);

    // Populate chat header
    const initial = contact.name.charAt(0).toUpperCase();
    document.getElementById('chatAvatar').textContent = initial;
    document.getElementById('chatContactName').textContent = contact.name;



    // Clear message fields
    document.getElementById('inputMessage').value = '';
    document.getElementById('outputMessage').value = '';

    this.showChatPage();
  },

  doKeyUpdates(contact, updateType, coder) {

      // Ğ¿Ğ¾Ğ´Ñ€ĞµĞ·ĞºĞ° ĞºĞ»ÑÑ‡Ğ°, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¿Ñ€Ğ¸ ĞµĞ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸
      if ( (coder.lastError === null) && contact.key_cleanup) {
          if (updateType === 'in') {
              const blanks = '#'.repeat(contact.key_in_position);
              contact.key_in = blanks + contact.key_in.substring(contact.key_in_position);
          } else {
              const blanks = '#'.repeat(contact.key_out_position);
              contact.key_out = blanks + contact.key_out.substring(contact.key_out_position);
          }
      }
      this.saveData();
      this.loadData();
      this.render();
      this.updateContactKeyLeftStat(contact);
  },

  encodeMessage() {
      const contact = this.data.contacts[this.currentContactId];
      const coder = new IVernarus1( contact.key_out,  contact.key_out_position, { 'deniability' : contact.use_deniability });
      const srcMessage = document.getElementById('inputMessage').value;
      const encoded = coder.encryptMessage(srcMessage);
      document.getElementById('outputMessage').value = encoded;

      if (contact.key_out.length <= contact.key_out_position) {
          alert('ĞšĞ»ÑÑ‡ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡Ğ¸');
          return;
      }

      contact.key_out_position = coder.lastKeyPos;

      this.doKeyUpdates(contact, 'out', coder);
  },

  decodeMessage() {
      const contact = this.data.contacts[this.currentContactId];

      const inputMessage = document.getElementById('outputMessage').value;

      // Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²ĞºĞ¸
      if (inputMessage === this.prevMessageForDecode && contact.key_cleanup) {
          alert('Ğ­Ñ‚Ğ¾ ÑĞ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ñ€Ğ°ÑÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾');
          return;
      }
      this.prevMessageForDecode = inputMessage;

      if (contact.key_in.length <= contact.key_in_position) {
          alert('ĞšĞ»ÑÑ‡ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ, Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡Ğ¸');
          return;
      }

      const coder = new IVernarus1( contact.key_in,  contact.key_in_position);
      const decoded = coder.decryptMessage(inputMessage);
      document.getElementById('inputMessage').value = decoded;

      contact.key_in_position = coder.lastKeyPos;

      this.doKeyUpdates(contact, 'in', coder);
  },

  // â”€â”€ Import / Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  exportData() {
    const dataStr = JSON.stringify(this.data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `address-book-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  },

  importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const imported = JSON.parse(e.target.result);
        
        // Validate data structure
        if (typeof imported !== 'object' || 
            typeof imported.last_id !== 'number' || 
            typeof imported.contacts !== 'object') {
          throw new Error('Invalid data structure');
        }

        // Validate contacts structure
        for (const [id, contact] of Object.entries(imported.contacts)) {
          if (!contact.name || 
              typeof contact.key !== 'string' || 
              typeof contact.key_position !== 'number') {
            throw new Error(`Invalid contact structure for ID ${id}`);
          }
          // key_cleanup is optional, default to false if missing
          if (contact.key_cleanup === undefined) {
            contact.key_cleanup = false;
          }
        }

        // Confirm before overwriting
        if (Object.keys(this.data.contacts).length > 0) {
          if (!confirm('This will replace all existing contacts. Continue?')) {
            event.target.value = ''; // Reset file input
            return;
          }
        }

        // Import data
        this.data = imported;
        this.saveData();
        this.render();
        alert('Data imported successfully!');
        
      } catch (err) {
        alert('Failed to import data: ' + err.message);
      }
      
      // Reset file input
      event.target.value = '';
    };
    reader.readAsText(file);
  },

  // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  showMainPage() {
    document.getElementById('mainPage').classList.remove('hidden');
    document.getElementById('editPage').classList.add('hidden');
    document.getElementById('chatPage').classList.add('hidden');
    this.currentContactId = null;
    this.uploadedKey = null;
  },

  showEditPage() {
    document.getElementById('mainPage').classList.add('hidden');
    document.getElementById('editPage').classList.remove('hidden');
    document.getElementById('chatPage').classList.add('hidden');
  },

  showChatPage() {
    document.getElementById('mainPage').classList.add('hidden');
    document.getElementById('editPage').classList.add('hidden');
    document.getElementById('chatPage').classList.remove('hidden');
  },

  // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
};

// Initialize app on load
document.addEventListener('DOMContentLoaded', () => app.init());
</script>

</body>
</html>
